# 数据库技术文档

本项目将数据库视为应用的核心逻辑层，而非简单的存储介质。通过深度集成高级特性，实现了数据的一致性校验和高效聚合。

## 📊 关系模型与范式设计

### 1. 核心实体 (Entities)
- **Users**: 存储角色信息的员工表。
- **Medicines**: 药品基础数据，包含进销价及实时库存。
- **Sales & Inbounds**: 核心业务流水，分别记录流向客户及来源于供应商的数据。

### 2. 范式分析
系统整体遵循 **BCNF (Boyce-Codd Normal Form)**：
- 无函数依赖冲突，所有非码属性完全依赖于码。
- 通过在业务主表引入 `order_id` 确保了业务可追溯性，同时在逻辑上将其解耦以提升查询性能。

## ⚙️ 数据库高级逻辑实现

### 1. 触发器 (Triggers): 自动化同步
- **库存闭环控制**：
    - 插入销售记录时扣减库存 (`tr_after_sale_insert`)。
    - 插入入库记录时增加库存 (`tr_after_inbound_insert`)。
    - 删除异常订单或记录时，自动回滚库存 (`tr_after_sale_delete`, `tr_after_inbound_delete`)。
- **严格校验**：
    - `tr_before_sale_check_stock`：在物理层拦截非法超支销售，确保库存 `stock` 永不为负。

### 2. 存储过程 (Stored Procedures): 复杂逻辑封装
存储过程承担了系统中 90% 的统计分析工作：
- **搜索优化**：`sp_search_medicines` 支持多字段模糊匹配与服务器端分页。
- **报表分析**：
    - `sp_sales_trend`：执行跨表聚合，计算指定时间段内的营收与毛利润。
    - `sp_top_selling_medicines`：实现动态列排序的排行榜逻辑，将排序负担移至数据库引擎。
- **原子业务**：`sp_update_sale` 封装了库存回滚、重算金额、新库存扣减等一系列操作，确保业务逻辑的一致性。

### 3. 视图 (Views): 数据封装与安全
- **权限隔离**：
    - `v_staff_medicines`：作为对普通员工暴露的数据接口，屏蔽了成本价字段。
- **报表抽象**：
    - `v_admin_financials`：预先聚合每日财务现状，后端只需执行简单的 `SELECT` 即可获取关键指标。

## 🛠️ 部署与维护
- **脚本分工**：
    - `init.sql`：定义 DDL 结构。
    - `advanced_features.sql`：单独维护所有 SP、Trigger 和 View。
    - `seed.sql`：提供高质量的测试数据，用于模拟真实销售环境。
