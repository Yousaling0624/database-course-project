# åç«¯æŠ€æœ¯æ–‡æ¡£

åç«¯ç³»ç»Ÿé‡‡ç”¨ Go è¯­è¨€ç¼–å†™ï¼Œéµå¾ª RESTful è§„èŒƒï¼Œæ ¸å¿ƒä¾§é‡äºé«˜æ€§èƒ½çš„æ•°æ®åååŠä¸ MySQL å­˜å‚¨è¿‡ç¨‹çš„æ·±åº¦è”åŠ¨ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

- **è¯­è¨€**: Go (Golang)
- **Web æ¡†æ¶**: [Gin](https://gin-gonic.com/)
- **ORM**: [GORM](https://gorm.io/)
- **å®‰å…¨æ€§**: Bcrypt å¯†ç å“ˆå¸Œã€è‡ªå®šä¹‰ CORS è·¨åŸŸæ§åˆ¶ã€‚

## ğŸ”Œ API æ¥å£å…¨é›†

| æ¨¡å— (Module) | æ–¹æ³• | è·¯å¾„ (Path) | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| **Auth** | POST | `/api/login` | ç”¨æˆ·ç™»å½•ï¼Œè¿”å› Token åŠç”¨æˆ·ä¿¡æ¯ |
| **Dashboard** | GET | `/api/dashboard/stats` | è·å–é¦–é¡µèšåˆæ•°æ® (åº“å­˜ã€é”€é‡ã€è¶‹åŠ¿) |
| **Users** | GET | `/api/users` | è·å–å‘˜å·¥åˆ—è¡¨ (åˆ†é¡µ) |
| | POST | `/api/users` | åˆ›å»ºæ–°å‘˜å·¥ (è‡ªåŠ¨å¤„ç†é‡å) |
| | PUT | `/api/users/:id` | æ›´æ–°å‘˜å·¥ä¿¡æ¯ |
| | DELETE | `/api/users/:id` | åˆ é™¤å‘˜å·¥ |
| **Medicines** | GET | `/api/medicines` | è·å–è¯å“åˆ—è¡¨ (æ”¯æŒ &search=xx) |
| | POST | `/api/medicines` | æ–°å¢è¯å“æ¡£æ¡ˆ |
| | PUT | `/api/medicines/:id` | æ›´æ–°è¯å“ä¿¡æ¯ |
| | DELETE | `/api/medicines/:id` | åˆ é™¤è¯å“ |
| **Sales** | GET | `/api/sales` | è·å–é”€å”®è®°å½• (æ”¯æŒ &keyword=xx) |
| | POST | `/api/sales` | åˆ›å»ºé”€å”®è®¢å• (è§¦å‘åº“å­˜æ‰£å‡) |
| | PUT | `/api/sales/:id` | ä¿®æ­£è®¢å• (Admin Only) |
| | DELETE | `/api/sales/:id` | åˆ é™¤è®¢å• (è§¦å‘åº“å­˜å›æ»š) |
| **Inbounds** | GET | `/api/inbounds` | è·å–å…¥åº“è®°å½• |
| | POST | `/api/inbounds` | åˆ›å»ºå…¥åº“å• (è§¦å‘åº“å­˜å¢åŠ ) |
| **Reports** | GET | `/api/reports/sales` | é”€å”®æ˜ç»†æŠ¥è¡¨ (æŒ‰æ—¥æœŸèŒƒå›´) |
| | GET | `/api/reports/financial`| è´¢åŠ¡ç»Ÿè®¡æŠ¥è¡¨ (è¥æ”¶/æˆæœ¬/æ¯›åˆ©) |
| **Search** | GET | `/api/search/users` | ç”¨æˆ·æ¨¡ç³Šæœç´¢ |
| | GET | `/api/search/customers` | å®¢æˆ·æ¨¡ç³Šæœç´¢ |

## ğŸ“¦ æ ¸å¿ƒæ•°æ®æ¨¡å‹ (Models)

åç«¯ä½¿ç”¨ Go Struct å®šä¹‰æ•°æ®æ¨¡å‹ï¼Œå¹¶é€šè¿‡ GORM Tag æ˜ å°„æ•°æ®åº“è¡¨ç»“æ„ã€‚

### 1. User (å‘˜å·¥)
```go
type User struct {
    ID        int64     `gorm:"primaryKey" json:"id"`
    Username  string    `gorm:"unique;not null" json:"username"`
    Password  string    `gorm:"not null" json:"-"` // JSON åºåˆ—åŒ–æ—¶éšè—å¯†ç 
    RealName  string    `json:"real_name"`
    Role      string    `gorm:"default:staff" json:"role"` // 'admin' or 'staff'
    CreatedAt time.Time `json:"created_at"`
}
```

### 2. Medicine (è¯å“)
```go
type Medicine struct {
    ID           int64   `gorm:"primaryKey" json:"id"`
    Code         string  `gorm:"unique;not null" json:"code"` // æ¡å½¢ç 
    Name         string  `gorm:"not null" json:"name"`
    Price        float64 `gorm:"type:decimal(10,2)" json:"price"`
    Stock        int     `gorm:"default:0" json:"stock"`
    Manufacturer string  `json:"manufacturer"`
}
```

### 3. Sales (é”€å”®è®°å½•)
```go
type Sales struct {
    ID         int64   `gorm:"primaryKey" json:"id"`
    OrderID    string  `gorm:"not null" json:"order_id"`
    MedicineID int64   `gorm:"not null" json:"medicine_id"`
    CustomerID int64   `json:"customer_id"`
    Quantity   int     `gorm:"not null" json:"quantity"`
    TotalPrice float64 `gorm:"type:decimal(10,2)" json:"total_price"`
    
    // GORM å…³è”æŸ¥è¯¢
    Medicine *Medicine `gorm:"foreignKey:MedicineID" json:"medicine,omitempty"`
    Customer *Customer `gorm:"foreignKey:CustomerID" json:"customer,omitempty"`
}
```

## ğŸ§  æ ¸å¿ƒé€»è¾‘æ·±åº¦è§£æ

### 1. æ¨¡ç³Šæœç´¢å®ç°
åç«¯é€šè¿‡ GORM çš„ `Raw` æ–¹æ³•ç›´æ¥è°ƒç”¨ MySQL å­˜å‚¨è¿‡ç¨‹ï¼Œå®ç°é«˜æ€§èƒ½çš„å¤šå­—æ®µæ¨¡ç³ŠåŒ¹é…ã€‚
```go
// internal/api/handlers.go
func GetMedicines(c *gin.Context) {
    // ...
    // è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ sp_search_medicines
    // å‚æ•°: keyword, filterStatus, limit, offset
    database.DB.Raw("CALL sp_search_medicines(?, ?, ?, ?)", search, filterStatus, limit, offset).Scan(&meds)
}
```

### 2. äº‹åŠ¡æ§åˆ¶ (Transaction)
åœ¨æ¶‰åŠå¤šè¡¨æ›´æ–°çš„æ“ä½œä¸­ï¼ˆå¦‚å…¥åº“åŒæ—¶æ›´æ–°åº“å­˜ï¼‰ï¼Œè™½ç„¶å¤§éƒ¨åˆ†é€»è¾‘å·²ä¸‹æ²‰è‡³æ•°æ®åº“è§¦å‘å™¨ï¼Œä½†åœ¨æŸäº›å¤æ‚åœºæ™¯ä¸‹ï¼ˆå¦‚æ‰‹åŠ¨è°ƒæ•´å¤šæ¡åº“å­˜ï¼‰ï¼Œåç«¯ä»ä¿ç•™äº†æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶èƒ½åŠ›ã€‚
```go
tx := database.DB.Begin()
if err := tx.Create(&inbound).Error; err != nil {
    tx.Rollback()
    return
}
tx.Commit()
```

## ğŸ’¾ æ•°æ®åº“è”åŠ¨

åç«¯ä¸æ•°æ®åº“ä¹‹é—´ä¸ä»…æ˜¯ CRUD å…³ç³»ï¼Œè¿˜åŒ…æ‹¬ï¼š
- **å­˜å‚¨è¿‡ç¨‹è§¦å‘**ï¼šè°ƒç”¨ `sp_top_selling_medicines` ç­‰å®ŒæˆåŠ¨æ€æ’åºçš„å¤æ‚èšåˆã€‚
- **é”™è¯¯æ•è·**ï¼šæ•è·å¹¶è§£ææ•°æ®åº“è§¦å‘å™¨æŠ›å‡ºçš„ `SIGNAL SQLSTATE`ï¼ˆå¦‚â€œåº“å­˜ä¸è¶³â€ï¼‰ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºå‹å¥½çš„ HTTP 400 å“åº”ã€‚

## ğŸš€ æ‰©å±•æ€§è®¾è®¡
- **é…ç½®éš”ç¦»**ï¼šé€šè¿‡ `internal/config` è¿›è¡Œç¯å¢ƒå˜é‡æ˜ å°„ã€‚
- **æ¥å£å…¼å®¹**ï¼šè¿”å›ç»“æ„åŒ– JSON å“åº”ï¼ŒåŒ…å« `data` å’Œ `meta` (åˆ†é¡µä¿¡æ¯)ã€‚
