# 医药销售管理系统 - 使用文档

本系统是一款专为医药销售行业设计的全栈管理方案，基于 **Go (Backend)** 和 **React (Frontend)** 开发，核心逻辑下沉至 **MySQL** 数据库层，充分利用了存储过程、触发器和视图等高级特性，确保数据处理的高效性与一致性。

---

## 🚀 快速开始

### 1. 环境准备
确保您的开发环境已安装以下软件：
- **Go**: Version 1.18+
- **Node.js**: Version 16+
- **MySQL**: Version 8.0+
- **Docker & Docker Compose** (推荐，用于一键部署)

### 2. 启动方式

#### 方式一：Docker 一键启动 (推荐)
在项目根目录下执行：
```bash
docker-compose up -d
```
- 前端地址：`http://localhost:5173`
- 后端地址：`http://localhost:8080`
- 数据库端口：`3306` (默认用户名/密码: `root`/`root`)

#### 方式二：手动启动

**后端 (Go):**
1. 进入 `backend` 目录。
2. 配置 `cmd/main.go` 中的数据库连接字符串 (默认连接本地 `pharma_db`)。
3. 执行 `go run cmd/main.go`。系统会自动进行 GORM 自动迁移。

**前端 (React):**
1. 进入 `frontend` 目录。
2. 执行 `npm install`。
3. 执行 `npm run dev`。

---

## 🛠️ 技术栈
- **后端**: Go (Gin 框架), GORM (ORM 层), MySQL 8.0
- **前端**: React (Vite), Tailwind CSS, Headless UI, Heroicons, Recharts (数据可视化)
- **数据库**: 深度集成存储过程、触发器、视图。

---

## 📖 核心功能

### 1. 工作台 (Dashboard)
- **实时指标**：展示今日销售额、订单量、当前库存药品总数及库存预警信息。
- **销售趋势**：通过折线图展示近期销售额波动，基于数据库存储过程 `sp_sales_trend` 统计。

### 2. 库存管理
- **药品档案**：管理药品的基本信息（编号、名称、规格、厂家、进货价、零售价等）。
- **库存预警**：自动标记库存低于阈值（如50件）或缺货的药品。

### 3. 销售管理
- **订单处理**：支持搜索药品并快速创建销售订单。
- **关联客户**：订单可关联现有客户信息，实现精准营销分析。
- **搜索过滤**：利用存储过程 `sp_search_sales` 实现对订单号、药品名、客户名的联合模糊搜索。

### 4. 采购入库
- **入库登记**：记录药品的入库数量、单价及供应商信息。
- **库存自动更新**：通过数据库触发器 `tr_after_inbound_insert` 实现入库后库存实时增加。

---

## 💾 数据库设计精要 (课程重点内容)

本项目将核心业务逻辑封装于数据库内，体现了数据库层面的逻辑控制：

### 1. 触发器 (Triggers) - 数据自动化
- **库存同步**：
  - `tr_after_sale_insert`: 销售成功后，自动扣减 `medicines` 表中对应药品的库存。
  - `tr_after_inbound_insert`: 入库成功后，自动增加对应药品的库存。
- **库存校验**：
  - `tr_before_sale_check_stock`: 在插入销售记录前检查库存，若库存不足则通过 `SIGNAL SQLSTATE` 抛出错误，阻止事务提交。
- **数据恢复**：
  - `tr_after_sale_delete`: 管理员删除销售记录后，自动回滚（增加）对应的药品库存。

### 2. 存储过程 (Stored Procedures) - 复杂查询与原子操作
- **分页搜索**：`sp_search_medicines`, `sp_search_sales` 等存储过程支持关键词匹配、分页 (`LIMIT`/`OFFSET`) 和状态过滤。
- **报表分析**：
  - `sp_sales_trend`: 接受日期范围，返回每日的订单数、营收、毛利。
  - `sp_top_selling_medicines`: 动态排序统计指定时间段内的热销药品排行。
- **原子操作**：通过存储过程封装多表更新逻辑（如 `sp_update_sale`），配合事务确保数据一致性。

### 3. 视图 (Views) - 数据封装与安全性
- **多角色权限视图**：
  - `v_staff_medicines`: 为普通员工展示，隐藏敏感的进货单价。
  - `v_admin_financials`: 专供管理员使用，包含每日营收、成本和利润明细。
- **业务汇总**：
  - `v_medicine_inventory`: 整合药品信息并动态计算库存状态（充足/不足/缺货）及库存总价值。

---

## 👤 管理员功能
- **数据修订**：管理员拥有对销售记录和入库记录的 **修改 (Edit)** 和 **删除 (Delete)** 权限。
- **权限控制**：系统预设了多级资源访问权限（基于 GORM 的用户认证），未来可配合数据库角色 `role_admin`, `role_staff` 实现更细粒度的控制。

---

## ❓ 常见问题
- **Q: 为什么销售订单创建失败？**
  - A: 请检查药品库存是否充足。触发器会强制校验库存，不足时会报错提示。
- **Q: 如何修改默认的登录账号？**
  - A: 系统首次启动时会自动创建 `admin/password`。您可以在登录后通过数据库管理工具或系统内部功能修改用户信息。
- **Q: 报表数据不更新？**
  - A: 报表数据是基于数据库实时统计的，请确认所属时间段内是否有有效的销售记录。
